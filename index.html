<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>餐廳隨機推薦器</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #map { height: 400px; margin-top: 20px; }
</style>
</head>
<body>

<h1>餐廳隨機推薦器</h1>
<p>請輸入地址（縣市 區 街道，例如：新北市三重區五華街）:</p>
<input type="text" id="address" style="width:300px;" placeholder="新北市三重區五華街">
<button onclick="findRestaurants()">搜尋附近餐廳</button>

<div id="result"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API_KEY = "pk.9052647f63ab5ea241dee09e510957f7"; // 你的 LocationIQ API Key
let map;
let markers = [];
let restaurants = [];

// 初始化地圖
function initMap(lat=25.0375, lon=121.5637) {
  if(map) map.remove();
  map = L.map('map').setView([lat, lon], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
}

// 隨機推薦餐廳
function pickRandomRestaurant() {
  if(restaurants.length === 0) return;
  const idx = Math.floor(Math.random() * restaurants.length);
  const r = restaurants[idx];
  document.getElementById("result").innerHTML = `
    <h3>隨機推薦餐廳</h3>
    <p><strong>${r.name}</strong></p>
    <p>地址: ${r.address}</p>
    <button onclick="pickRandomRestaurant()">重新抽選</button>
  `;
}

// 查詢餐廳
async function findRestaurants() {
  const address = document.getElementById("address").value.trim();
  if(!address) return alert("請輸入地址");

  // 清除舊標記
  markers.forEach(m => map?.removeLayer(m));
  markers = [];
  restaurants = [];
  document.getElementById("result").innerHTML = '';

  try {
    // 拆解使用者輸入，假設格式 "縣市 區 街道"
    let state, city, street;
    const parts = address.match(/^(.{2,3}市)(.{2,3}區)(.+)$/);
    if(parts){
      [, state, city, street] = parts.map(s => s.trim());
    } else {
      alert("地址格式錯誤，請輸入縣市+區+街道");
      return;
    }

    // LocationIQ 搜尋街道
    const geoRes = await fetch(`https://us1.locationiq.com/v1/search.php?key=${API_KEY}&q=${street}&country=Taiwan&format=json`);
    const geoData = await geoRes.json();

    if(!geoData.length) return alert("找不到地址");

    // 使用 address 欄位比對縣市與區
    const filtered = geoData.filter(item => {
      const a = item.address || {};
      return a.state?.includes(state) && a.city?.includes(city);
    });

    let location;
    if(filtered.length === 0) {
      location = geoData[0]; // fallback
      alert("精確匹配失敗，使用第一筆結果，請確認位置是否正確");
    } else if(filtered.length === 1) {
      location = filtered[0];
    } else {
      const choice = prompt(
        "找到多筆可能位置，請輸入要使用的編號:\n" + 
        filtered.map((item, i) => `${i}: ${item.display_name}`).join("\n")
      );
      location = filtered[parseInt(choice)] || filtered[0];
    }

    const lat = parseFloat(location.lat);
    const lon = parseFloat(location.lon);

    // 初始化地圖
    initMap(lat, lon);

    // 標示搜尋範圍 1 公里
    L.circle([lat, lon], { radius: 1000, color: 'blue', fillOpacity: 0.1 }).addTo(map);

    // 查詢附近餐廳 (Overpass API)
    const query = `
      [out:json];
      node["amenity"="restaurant"](around:1000,${lat},${lon});
      out;
    `;
    const overpassRes = await fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST',
      body: query
    });
    const data = await overpassRes.json();
    if(!data.elements.length) return alert("附近沒有找到餐廳");

    restaurants = data.elements.map(e => ({
      name: e.tags.name || "未知名稱",
      address: `${e.tags['addr:street'] || ''} ${e.tags['addr:housenumber'] || ''}`.trim(),
      lat: e.lat,
      lon: e.lon
    }));

    // 在地圖上標記餐廳
    restaurants.forEach(r => {
      const m = L.marker([r.lat, r.lon]).addTo(map).bindPopup(r.name);
      markers.push(m);
    });

    // 先隨機抽一間
    pickRandomRestaurant();

  } catch(err) {
    console.error(err);
    alert("定位或查詢餐廳失敗，請稍後再試。");
  }
}

// 初始化地圖到台北中心
initMap();
</script>
</body>
</html>
