<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>餐廳隨機推薦器</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { margin:0; font-family: Arial,sans-serif; display:flex; flex-direction:column; height:100vh; }
#controls { padding:10px; background:#f2f2f2; }
input, button, select { padding:8px; margin:5px 0; width:100%; max-width:400px; }
#map { flex:1; width:100%; }
#cards { display:flex; flex-wrap:wrap; margin-top:10px; }
.card {
    border:1px solid #ccc; border-radius:5px; padding:10px; margin:5px;
    width: calc(100% - 20px); max-width:250px; cursor:pointer; background:#fafafa;
    transition:0.2s; box-shadow:0 1px 3px rgba(0,0,0,0.2);
}
.card:hover { box-shadow:0 3px 6px rgba(0,0,0,0.3); background:#fff; }
@media(min-width:600px){ .card{ width:200px; } }
</style>
</head>
<body>

<div id="controls">
<h2>餐廳隨機推薦器</h2>
<input type="text" id="addressInput" placeholder="請輸入地址（例：新北市三重區五華街）">
<button onclick="searchAddress()">搜尋地址</button>
<select id="addressSelect" onchange="confirmAddress()" style="display:none;"></select>
<button id="reshuffleBtn" onclick="reshuffleRestaurant()" style="display:none;">重新抽選餐廳</button>
<div id="cards"></div>
<p>⚠️ 若想查看 API 使用狀況，請自行前往 <a href="https://locationiq.com/dashboard" target="_blank">LocationIQ Dashboard</a></p>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const API_KEY = "pk.bc63f534da0350a75d49564feb994bfd";

let map = L.map('map').setView([25.0478,121.5319],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let addressResults = [];
let lastRestaurants = [];
let restaurantMarkers = [];
let selectedRestaurant = null;

// 搜尋地址
function searchAddress(){
    const query = document.getElementById("addressInput").value.trim();
    if(!query){ alert("請輸入地址"); return; }

    fetch(`https://us1.locationiq.com/v1/search.php?key=${API_KEY}&q=${encodeURIComponent(query)}&format=json&countrycodes=TW`)
    .then(res=>{
        if(res.status===401) throw new Error("API_KEY_INVALID");
        if(!res.ok) throw new Error("API_ERROR");
        return res.json();
    })
    .then(data=>{
        if(!Array.isArray(data) || data.length===0){ alert("找不到這個地址，請重新輸入"); return; }

        addressResults = data;
        const select = document.getElementById("addressSelect");
        select.innerHTML="";
        select.style.display = data.length>1 ? "block" : "none";

        if(data.length>1){
            data.forEach((d,i)=>{
                const opt = document.createElement("option");
                opt.value = i;
                opt.textContent = d.display_name;
                select.appendChild(opt);
            });
            alert("請從下方清單選擇正確的地址");
        } else {
            setAddress(data[0]);
        }
    })
    .catch(err=>{
        console.error(err);
        if(err.message==="API_KEY_INVALID") alert("API key 無效，請確認你的 LocationIQ API key");
        else alert("定位服務異常，請稍後再試");
    });
}

// 確認地址
function confirmAddress(){
    const select = document.getElementById("addressSelect");
    const index = select.value;
    if(index==="") return;
    setAddress(addressResults[index]);
}

// 設定地址經緯度並查餐廳
function setAddress(item){
    const lat = parseFloat(item.lat);
    const lon = parseFloat(item.lon);
    map.setView([lat, lon],15);
    findRestaurants(lat, lon);
}

// 查附近餐廳
function findRestaurants(lat, lon){
    const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];(
        node["amenity"="restaurant"](around:1000,${lat},${lon});
        way["amenity"="restaurant"](around:1000,${lat},${lon});
        relation["amenity"="restaurant"](around:1000,${lat},${lon});
    );out center tags;`;

    fetch(overpassUrl)
    .then(res=>res.json())
    .then(data=>{
        let elements = data.elements || [];
        elements = elements.filter(e=>{
            const t = e.tags||{};
            if(t.disused||t.abandoned||t["disused:amenity"]) return false;
            if(t.shop==="vacant") return false;
            return true;
        });

        if(!elements.length){ alert("附近 1 公里沒有找到可用餐廳"); return; }

        lastRestaurants = elements;
        document.getElementById("reshuffleBtn").style.display = "inline-block";
        drawRestaurants();
    })
    .catch(err=>{
        console.error(err);
        alert("查詢餐廳時發生錯誤");
    });
}

// 顯示餐廳、隨機挑一間紅色大頭釘
function drawRestaurants(){
    restaurantMarkers.forEach(m=>map.removeLayer(m));
    restaurantMarkers=[];
    selectedRestaurant = null;
    const cardsDiv = document.getElementById("cards");
    cardsDiv.innerHTML="";

    // 隨機抽一間
    const shuffled = lastRestaurants.sort(()=>0.5-Math.random());
    selectedRestaurant = shuffled[0];

    shuffled.forEach(r=>{
        const rlat = r.lat || r.center?.lat;
        const rlon = r.lon || r.center?.lon;
        const name = r.tags.name || "未提供名稱";
        const hours = r.tags.opening_hours || "未提供營業時間";

        const isSelected = r===selectedRestaurant;
        const marker = L.marker([rlat, rlon],{
            icon: L.icon({
                iconUrl: isSelected ? "https://chart.googleapis.com/chart?chst=d_map_pin_icon&chld=restaurant|ff0000"
                                     : "https://chart.googleapis.com/chart?chst=d_map_pin_icon&chld=restaurant|008000",
                iconSize:[32,32]
            })
        }).addTo(map);
        restaurantMarkers.push(marker);
        marker.bindPopup(`<b>${name}</b><br>營業時間：${hours}`);

        const card = document.createElement("div");
        card.className="card";
        card.innerHTML=`<b>${name}</b><br>營業時間：${hours}`;
        card.onclick=()=>{
            map.setView([rlat, rlon],17);
            marker.openPopup();
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(rlat+","+rlon)}`, "_blank");
        };
        cardsDiv.appendChild(card);
    });

    // 自動聚焦選中餐廳
    if(selectedRestaurant){
        const rlat = selectedRestaurant.lat || selectedRestaurant.center?.lat;
        const rlon = selectedRestaurant.lon || selectedRestaurant.center?.lon;
        map.setView([rlat, rlon],17);
    }
}

// 重新抽選
function reshuffleRestaurant(){
    if(!lastRestaurants.length){ alert("尚未查詢到餐廳，請先搜尋地址"); return; }
    drawRestaurants();
}
</script>

</body>
</html>
