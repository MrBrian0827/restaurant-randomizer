<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>餐廳隨機推薦器</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { margin:0; font-family: Arial,sans-serif; display:flex; flex-direction:column; height:100vh; }
#controls { padding:10px; background:#f2f2f2; }
input, button, select { padding:8px; margin:5px 0; width:100%; max-width:400px; }
#map { flex:1; width:100%; }
#info, #addressHint { padding:10px; background:#fff; font-size:16px; }
#apiUsage { font-size:14px; color:#555; margin-top:10px; white-space:pre-line; }
#cards { display:flex; flex-wrap:wrap; margin-top:10px; }
.card {
    border:1px solid #ccc; border-radius:5px; padding:10px; margin:5px;
    width: calc(100% - 20px); max-width:250px; cursor:pointer; background:#fafafa;
    transition:0.2s; box-shadow:0 1px 3px rgba(0,0,0,0.2);
}
.card:hover { box-shadow:0 3px 6px rgba(0,0,0,0.3); background:#fff; }
@media(min-width:600px){ .card{ width:200px; } }
#addressHint { color: #c00; margin-top:5px; }
</style>
</head>
<body>

<div id="controls">
<h2>餐廳隨機推薦器</h2>
<input type="text" id="addressInput" placeholder="請輸入地址（例：新北市三重區五華街）">
<button onclick="searchAddress()">搜尋地址</button>
<select id="addressSelect" onchange="confirmAddress()" style="display:none;"></select>
<div id="addressHint"></div>
<button id="reshuffleBtn" onclick="reshuffleRestaurants()" style="display:none;">重新抽選五家餐廳</button>
<div id="apiUsage"></div>
<div id="cards"></div>
</div>

<div id="map"></div>
<div id="info"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ================== ⚙ 設定 API Key 與月額次數 ==================
const API_KEY="pk.bc63f534da0350a75d49564feb994bfd"; // <-- 填入你的 API Key
const MONTHLY_LIMIT=5000;

// ================== API 次數管理 ==================
function initApiUsage(){
    const now=new Date();
    const currentMonth=now.getFullYear()*100+(now.getMonth()+1);
    let usage=JSON.parse(localStorage.getItem("locationiq_usage"));
    if(!usage||usage.month!==currentMonth){
        usage={month:currentMonth,count:0};
        localStorage.setItem("locationiq_usage",JSON.stringify(usage));
    }
    return usage;
}
function incrementApiUsage(){ 
    let usage=initApiUsage(); 
    usage.count++; 
    localStorage.setItem("locationiq_usage",JSON.stringify(usage)); 
    updateApiUsageUI(); 
}
function updateApiUsageUI(){ 
    let usage=initApiUsage(); 
    let remain=MONTHLY_LIMIT-usage.count; if(remain<0) remain=0; 
    document.getElementById("apiUsage").innerText=
        `LocationIQ 每月免費額度：${MONTHLY_LIMIT} 次\n本月已使用：${usage.count} 次\n剩餘：${remain} 次\n\n⚠️ 此 API key 為前端使用，請僅在授權網站使用，避免濫用。`;
}

// ================== 地圖初始化 ==================
const map=L.map('map').setView([25.0478,121.5319],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let restaurantMarkers=[];
let lastRestaurants=[], lastLat=0, lastLon=0;

// ================== 查地址 ==================
function searchAddress(){
    const q=document.getElementById("addressInput").value.trim();
    if(!q){ alert("請輸入地址"); return; }

    fetch(`https://us1.locationiq.com/v1/search.php?key=${API_KEY}&q=${encodeURIComponent(q)}&format=json`)
    .then(res=>{
        if(res.status===401) throw new Error("API_KEY_INVALID");
        if(res.status===403) throw new Error("API_KEY_FORBIDDEN");
        if(!res.ok) throw new Error("API_ERROR");
        return res.json();
    })
    .then(data=>{
        if(!Array.isArray(data)||data.length===0){ 
            document.getElementById("addressHint").innerText="找不到這個地址，請重新輸入";
            return; 
        }
        incrementApiUsage();

        const select=document.getElementById("addressSelect");
        select.style.display="block";
        select.innerHTML="";
        const inputCity=q.split(/市|縣/)[0]+"市"; // 提取使用者輸入的城市
        data.forEach((d,i)=>{
            const display=d.display_name;
            const option=document.createElement("option");
            option.value=i;
            option.textContent=display;
            // 標註不匹配城市
            if(!display.includes(inputCity)){
                option.textContent += " ⚠️ 城市可能不正確";
            }
            select.appendChild(option);
        });
        document.getElementById("addressHint").innerText="請從下方清單選擇正確的地址";
    })
    .catch(err=>{
        console.error(err);
        if(err.message==="API_KEY_INVALID") alert("API key 無效，請確認你的 LocationIQ API key");
        else if(err.message==="API_KEY_FORBIDDEN") alert("API key 未授權使用此網站，請在 LocationIQ 控制台設定 HTTP Referrer");
        else alert("定位服務異常，請稍後再試");
    });
}

// ================== 確認地址 → 查餐廳 ==================
function confirmAddress(){
    const select=document.getElementById("addressSelect");
    const index=select.value;
    if(index==="") return;
    const q=document.getElementById("addressInput").value.trim();

    fetch(`https://us1.locationiq.com/v1/search.php?key=${API_KEY}&q=${encodeURIComponent(q)}&format=json`)
    .then(res=>{
        if(res.status===401) throw new Error("API_KEY_INVALID");
        if(res.status===403) throw new Error("API_KEY_FORBIDDEN");
        if(!res.ok) throw new Error("API_ERROR");
        return res.json();
    })
    .then(data=>{
        const item=data[index];
        lastLat=parseFloat(item.lat); lastLon=parseFloat(item.lon);
        map.setView([lastLat,lastLon],15);
        incrementApiUsage();
        findRestaurants(lastLat,lastLon);
        document.getElementById("addressHint").innerText="";
    })
    .catch(err=>{
        console.error(err);
        if(err.message==="API_KEY_INVALID") alert("API key 無效，請確認你的 LocationIQ API key");
        else if(err.message==="API_KEY_FORBIDDEN") alert("API key 未授權使用此網站，請在 LocationIQ 控制台設定 HTTP Referrer");
        else alert("定位服務異常，請稍後再試");
    });
}

// ================== 查附近餐廳 ==================
function findRestaurants(lat,lon){
    const overpassUrl=`https://overpass-api.de/api/interpreter?data=[out:json];(
        node["amenity"="restaurant"](around:1000,${lat},${lon});
        way["amenity"="restaurant"](around:1000,${lat},${lon});
        relation["amenity"="restaurant"](around:1000,${lat},${lon});
    );out center tags;`;

    fetch(overpassUrl)
    .then(res=>res.json())
    .then(data=>{
        let elements=data.elements;
        if(!elements.length){ alert("附近 1 公里沒有找到餐廳"); return; }
        elements=elements.filter(e=>{ const t=e.tags||{}; if(t.disused||t.abandoned||t["disused:amenity"]) return false; if(t.shop==="vacant") return false; return true; });
        if(!elements.length){ alert("找到餐廳，但似乎都已歇業"); return; }
        lastRestaurants=elements;
        document.getElementById("reshuffleBtn").style.display="inline-block";
        displayRestaurantCards();
    })
    .catch(err=>{ console.error(err); alert("查詢餐廳時發生錯誤"); });
}

// ================== 顯示餐廳卡片 ==================
function displayRestaurantCards(){
    restaurantMarkers.forEach(m=>map.removeLayer(m));
    restaurantMarkers=[];
    const cardsDiv=document.getElementById("cards");
    cardsDiv.innerHTML="";
    const shuffled=lastRestaurants.sort(()=>0.5-Math.random());
    const selected=shuffled.slice(0,5);
    selected.forEach(r=>{
        const rlat=r.lat||r.center?.lat, rlon=r.lon||r.center?.lon;
        const name=r.tags.name||"未提供名稱";
        const hours=r.tags.opening_hours||"未提供營業時間";
        const addr=r.tags["addr:full"]||r.tags["addr:street"]||"無地址資料";

        const marker=L.marker([rlat,rlon],{icon:L.icon({iconUrl:"https://chart.googleapis.com/chart?chst=d_map_pin_icon&chld=restaurant|ff0000", iconSize:[32,32]})}).addTo(map);
        restaurantMarkers.push(marker);
        marker.bindPopup(`<b>${name}</b><br>${addr}<br>營業時間：${hours}`);

        const card=document.createElement("div"); card.className="card";
        card.innerHTML=`<b>${name}</b><br>營業時間：${hours}`;
        card.onclick=()=>{
            map.setView([rlat,rlon],17);
            marker.openPopup();
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(rlat + "," + rlon)}`,"_blank");
        };
        cardsDiv.appendChild(card);
    });
}

// ================== 重新抽選 ==================
function reshuffleRestaurants(){
    if(!lastRestaurants.length){ alert("尚未查詢到餐廳，請先搜尋地址"); return; }
    displayRestaurantCards();
}

updateApiUsageUI();
</script>

</body>
</html>
